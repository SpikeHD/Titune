"use strict";(()=>{function v(){return new URLSearchParams(window.location.search).get("name")}function u(){return new URLSearchParams(window.location.search).get("id")}var m=["AUDIO_QUALITY_ULTRALOW","AUDIO_QUALITY_LOW","AUDIO_QUALITY_MEDIUM","AUDIO_QUALITY_HIGH"],N={invidiousInstance:"https://vid.puffyan.us/",shaders:!0,volume:50,preferredCodec:"opus",maxQuality:"AUDIO_QUALITY_HIGH",showNotices:!0,fullyHideSidebar:!1};function a(){let t=localStorage.getItem("options");return t?JSON.parse(t):N}function p(t,e){let o=a();o[t]=e,localStorage.setItem("options",JSON.stringify(o))}var L=[];async function g(t,e){if(!a().showNotices)return;let o=document.createElement("div"),n=document.querySelector("#notice-container");o.classList.add("notice"),o.classList.add(e),o.textContent=t;let s=n.appendChild(o);await new Promise(i=>setTimeout(i,100)),s.classList.add("show"),L.push(s),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>{s.remove(),L.splice(L.indexOf(s),1)},100)},5e3)}var E=[];async function w(t){if(E.length>0)return E;let e=a().invidiousInstance,o=e.endsWith("/")?e:e+"/",n=await fetch(`${o}api/v1/playlists/${t}`).then(s=>s.json());return E.push(...n.videos),n.videos}async function R(t){let e=a().invidiousInstance,o=e.endsWith("/")?e:e+"/";return(await fetch(`${o}api/v1/videos/${t}`).then(s=>s.json())).adaptiveFormats.filter(s=>s.type.startsWith("audio/"))}async function b(t){let e=await R(t),{preferredCodec:o}=a(),n=e.filter(i=>i.type.includes(o));return V(n)||n[0]||e[0]}function V(t){let{maxQuality:e}=a(),o=m.filter(s=>m.indexOf(s)<=m.indexOf(e)).sort((s,i)=>m.indexOf(s)-m.indexOf(i));return t.find(s=>o.some(i=>s.audioQuality.includes(i)))}async function S(t){let e=await w(t),o=Date.now()/1e3,n=e.reduce((i,r)=>i+r.lengthSeconds,0),s=Math.floor(o/n);return H(e,s)}function H(t,e){let o=[...t];for(let n=o.length-1;n>0;n--){let s=Math.floor((e+n)%(n+1)),i=o[n];o[n]=o[s],o[s]=i}return o}async function f(t){let e=await S(t),o=Date.now(),n=0;for(let c of e)n+=c.lengthSeconds;let s=Math.floor(o/1e3%n),i=0,r;for(let c of e)if(i+=c.lengthSeconds,s<i){r=c;break}let l=s-(i-r.lengthSeconds);return{song:r,elapsed:l}}async function M(t,e){let o=await S(t),n=await f(t),s=o.findIndex(i=>i.videoId===n.song?.videoId);return s+=e,s%=o.length,o[s]}async function y(t,e){let o=document.getElementById("radio-audio"),n=await b(t.videoId);o.src=n.url,o.currentTime=e,o.onerror=r=>{console.error(r),g("An error occurred while trying to play the song. Check DevTools. Is it DRM protected?","error")};let s=await M(u(),1),i=await b(s.videoId);await W(i)}async function U(){let t=document.getElementById("radio-audio"),{volume:e}=a();t.volume=e/100}async function W(t){console.log("Caching next song: ",t.url);let e=document.createElement("audio");e.src=t.url,e.preload="metadata";let o=document.body.appendChild(e);o.onloadeddata=()=>{o.remove()},o.onerror=n=>{console.error(n),g("There was an error preloading the next song. It may or may not load.","error")}}document.addEventListener("DOMContentLoaded",()=>{let t=a().fullyHideSidebar,e=document.getElementById("side-options"),o=document.getElementById("add-open"),n=document.getElementById("add-close"),s=document.getElementById("options-close"),i=document.getElementById("list-close"),r=document.getElementById("list-submit");e.style.opacity=t?"0":"0.1",e.addEventListener("mouseenter",()=>{e.style.opacity="1"}),e.addEventListener("mouseleave",()=>{e.style.opacity=t?"0":"0.1"}),o.addEventListener("click",()=>{let l=document.getElementById("playlist-input"),c=document.getElementById("radio-name-input"),d=l.value;if(!d)return;let O=new URL(d).searchParams.get("list")??d;window.location.search=`?id=${O}&name=${c.value}`}),n.addEventListener("click",()=>{B("add-dialog")}),s.addEventListener("click",()=>{B("options-dialog")}),i.addEventListener("click",()=>{B("list-dialog")}),r.addEventListener("click",()=>{open("https://github.com/SpikeHD/Titune/issues/new?assignees=&labels=submission&projects=&template=submission.md&title=%5BSUBMISSION%5D","_blank")})});function x(t){document.getElementById(t).showModal()}function B(t){document.getElementById(t).close()}function $(){let t=document.getElementById("add-icon"),e=document.getElementById("options-icon"),o=document.getElementById("list-icon");t.addEventListener("click",()=>{x("add-dialog")}),e.addEventListener("click",()=>{x("options-dialog")}),o.addEventListener("click",()=>{x("list-dialog")});let n=document.querySelectorAll(".option-row input"),s=document.querySelectorAll(".option-row select");n.forEach(i=>{let r=i.dataset.option;i.type==="checkbox"?i.checked=a()[r]:i.value=a()[r],i.onchange=()=>{if(i.type==="checkbox"){p(r,i.checked);return}p(r,i.value)}}),s.forEach(i=>{let r=i.dataset.option;i.value=a()[r],i.onchange=()=>{p(r,i.value)}})}async function P(){let t=await fetch(`https://${location.host+location.pathname}station_list.json`).catch(()=>g("Failed to load radio submissions.","error")),e=t?.json&&await t.json();e&&Object.entries(e).forEach(([o,n])=>{let s=document.createElement("a");s.classList.add("submission-row"),s.href=`?id=${n.playlist_id}&name=${o}`,s.target="_blank";let i=document.createElement("div");i.classList.add("submission-cell"),i.textContent=o;let r=document.createElement("div");r.classList.add("submission-cell"),r.textContent=n.submitted_by,s.appendChild(i),s.appendChild(r),document.querySelector(".submission-body").appendChild(s)})}function h(t){let e=document.getElementById("radio-audio"),o=document.querySelector("#volume-bar"),n=o.querySelectorAll(".volume-bar-line"),s=document.querySelector("#volume-number");t<0&&(t=0),t>100&&(t=100),t>0?o.classList.remove("muted"):o.classList.add("muted"),e.volume=t/100;let i=Math.round(t/(100/n.length))*(100/n.length);n.forEach(r=>r.classList.remove("active"));for(let r=0;r<i/(100/n.length);r++)n[r].classList.add("active");s.textContent=`${t}%`,p("volume",t)}function q(){if(!document.getElementById("radio-audio").paused)return;let e=async()=>{let{song:o,elapsed:n}=await f(u());y(o,n),document.removeEventListener("click",e)};document.addEventListener("click",e)}document.addEventListener("DOMContentLoaded",()=>{let t=document.querySelector("#volume-bar");t.addEventListener("click",n=>{let i=Math.floor(n.offsetX/t.clientWidth*100);h(i)}),t.addEventListener("mousedown",n=>{let i=Math.floor(n.offsetX/t.clientWidth*100);h(i),document.addEventListener("mousemove",e),document.addEventListener("mouseup",o)});let e=n=>{let s=n;if(s.target!==t)return;let i=Math.floor(s.offsetX/t.clientWidth*100);h(i)},o=()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",o)}});function _(){let t=document.querySelector("#volume"),e=()=>{t.classList.remove("hide")},o=()=>{t.classList.add("hide")};o(),t.addEventListener("mouseenter",e),t.addEventListener("mouseleave",o)}var j=new URLSearchParams(window.location.search).get("obs")==="true";if(u()&&v()){let t=v(),e=document.querySelectorAll('meta[name*="title"]'),o=document.querySelectorAll('meta[name*="description"]');for(let n of e)n.setAttribute("content","Titune");for(let n of o)n.setAttribute("content",`Listen along to "${t}" Radio`)}document.addEventListener("DOMContentLoaded",async()=>{j&&(document.documentElement.classList.add("transparent"),_()),$();let t=document.getElementById("currently-playing"),e=document.getElementById("time-elapsed"),o=document.getElementById("duration"),n=document.getElementById("cover"),s=document.getElementById("radio-audio"),i=u(),r="",l=v();if(document.title=l?`Titune | ${l}`:"Titune",U(),h(0),q(),P(),!i){t.textContent="Create a radio from the top left!";return}i&&(await w(i),s.onloadeddata=async()=>{let{song:c,elapsed:d}=await f(i);y(c,d),s.play()},setInterval(async()=>{let{song:c,elapsed:d}=await f(i);if(!r.includes(c?.title??"Unknown")&&c){let I=(c.videoThumbnails.length>0&&Array.isArray(c.videoThumbnails[0])?c.videoThumbnails[0]:c.videoThumbnails).reduce((k,T)=>T.width>k.width?T:k).url;n.setAttribute("src",I);let D=document.getElementById("bg-cover");D.style.backgroundImage=`url(${I})`,document.getElementById("favicon").setAttribute("href",I),y(c,d)}if(`${c?.title??"Unknown"}${d}`===r)return;t.textContent=c?.title??"Unknown",e.textContent=`${Math.floor(d/60)}:${Math.floor(d%60).toString().padStart(2,"0")}`,o.textContent=`${Math.floor((c?.lengthSeconds??0)/60)}:${Math.floor((c?.lengthSeconds??0)%60).toString().padStart(2,"0")}`;let A=document.getElementById("progress-bar-fill"),C=d/(c?.lengthSeconds??1)*100;A.style.width=`${C}%`,r=`${c?.title??"Unknown"}${d}`},200))});})();
//# sourceMappingURL=bundle.js.map
